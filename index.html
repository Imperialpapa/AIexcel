<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>K-IFRS ë°ì´í„° ê²€ì¦</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        /* Header & Toolbar */
        header { padding: 12px; background: #f3f3f3; border-bottom: 1px solid #ccc; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: space-between; }
        .toolbar-group { display: flex; gap: 8px; align-items: center; }

        /* Main Content Area (Grid + Side Panel) */
        #main-content { display: flex; flex: 1; overflow: hidden; }

        /* Grid Area */
        #grid-container { flex: 1; overflow: auto; position: relative; background: #fff; }
        table { border-collapse: collapse; min-width: 100%; font-size: 14px; }
        th, td { border: 1px solid #e0e0e0; min-width: 80px; padding: 6px; text-align: center; outline: none; }
        th { background: #f9f9f9; position: sticky; top: 0; z-index: 10; font-weight: 600; color: #555; border-bottom: 2px solid #ccc; }
        td:focus { border: 2px solid #107c41; background: #e8f5e9; }

        /* Sheet Tabs (Bottom) */
        #sheet-tabs { background: #e0e0e0; padding: 0; display: flex; overflow-x: auto; border-top: 1px solid #ccc; }
        .sheet-tab { padding: 8px 15px; cursor: pointer; background: #e0e0e0; border-right: 1px solid #ccc; font-size: 13px; user-select: none; }
        .sheet-tab.active { background: #fff; color: #107c41; font-weight: bold; border-bottom: 3px solid #107c41; }
        .sheet-tab:hover:not(.active) { background: #d0d0d0; }
        .sheet-tab.empty { color: #999; font-style: italic; }

        /* AI Side Panel */
        #ai-panel { width: 320px; min-width: 200px; max-width: 600px; border-left: 2px solid #ccc; background: #f9f9f9; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        #ai-panel.collapsed { width: 0; min-width: 0; border: none; }
        #ai-panel-resizer { width: 6px; height: 100%; position: absolute; left: 0; top: 0; cursor: col-resize; background: transparent; z-index: 100; }
        #ai-panel-resizer:hover { background: #107c41; opacity: 0.3; }
        #ai-panel-header { padding: 12px; background: #107c41; color: white; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        #ai-panel-toggle { background: transparent; border: none; color: white; cursor: pointer; font-size: 18px; padding: 4px; }
        #ai-history { flex: 1; overflow-y: auto; padding: 10px; }
        .ai-entry { background: white; margin-bottom: 10px; padding: 10px; border-radius: 6px; border-left: 4px solid #107c41; font-size: 13px; }
        .ai-entry-time { color: #666; font-size: 11px; margin-bottom: 4px; }
        .ai-entry-command { font-weight: bold; color: #107c41; margin-bottom: 6px; }
        .ai-entry-result { color: #333; }
        .ai-entry-error { border-left-color: #d32f2f; }
        .ai-entry-error .ai-entry-command { color: #d32f2f; }
        body.resizing { cursor: col-resize; user-select: none; }
        body.resizing * { cursor: col-resize !important; }

        /* AI & UI Components */
        .btn { padding: 8px 14px; cursor: pointer; background: #107c41; color: white; border: none; border-radius: 4px; font-weight: 500; transition: 0.2s; }
        .btn:hover { background: #0c5e31; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .btn-toggle { background: #666; padding: 6px 10px; font-size: 12px; }

        input[type="text"], input[type="password"] { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        #ai-prompt { width: 300px; }
        #api-key { width: 200px; }

        /* Loading Indicator */
        #loading { display: none; color: #107c41; font-weight: bold; margin-left: 10px; }

        /* Performance Stats */
        #stats { font-size: 11px; color: #666; padding: 4px 12px; background: #fff; border-radius: 4px; }

        /* File Loading Overlay */
        #file-loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center; }
        #file-loading-overlay.show { display: flex; }
        .loading-content { background: white; padding: 30px 50px; border-radius: 8px; text-align: center; }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #107c41; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<header>
    <div class="toolbar-group">
        <input type="file" id="fileInput" hidden />
        <button class="btn" onclick="app.excelIO.triggerImport()">ğŸ“‚ ì—´ê¸°</button>
        <button class="btn" onclick="app.excelIO.exportFile()">ğŸ’¾ ì €ì¥</button>
        <span id="stats"></span>
    </div>

    <div class="toolbar-group">
        <input type="password" id="api-key" placeholder="OpenAI API Key ì…ë ¥" />
        <input type="text" id="ai-prompt" placeholder="ì˜ˆ: ê°€ê²©ì´ ë†’ì€ ìˆœìœ¼ë¡œ ì •ë ¬í•´ì¤˜" />
        <button class="btn" id="ai-btn" onclick="app.aiEngine.processCommand()">âœ¨ AI ì‹¤í–‰</button>
        <button class="btn btn-toggle" onclick="app.toggleAIPanel()">AI íŒ¨ë„</button>
        <span id="loading">ì²˜ë¦¬ì¤‘... ğŸ¤–</span>
    </div>
</header>

<div id="main-content">
    <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
        <div id="grid-container">
            <table id="spreadsheet">
                <thead><tr id="header-row"></tr></thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
        <div id="sheet-tabs"></div>
    </div>

    <div id="ai-panel">
        <div id="ai-panel-resizer"></div>
        <div id="ai-panel-header">
            <span>AI ì‘ì—… íˆìŠ¤í† ë¦¬</span>
            <button id="ai-panel-toggle" onclick="app.toggleAIPanel()">âœ•</button>
        </div>
        <div id="ai-history"></div>
    </div>
</div>

<div id="file-loading-overlay">
    <div class="loading-content">
        <div class="loading-spinner"></div>
        <div id="loading-message">íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
</div>

<script>
/**
 * 1. GridManager: ë©€í‹° ì‹œíŠ¸ ê´€ë¦¬ ë° ë Œë”ë§ (ìµœì í™” ë²„ì „)
 */
class GridManager {
    constructor(tableId, tabsId) {
        this.tableBody = document.querySelector(tableId + ' tbody');
        this.headerRow = document.querySelector(tableId + ' thead tr');
        this.tabsContainer = document.querySelector(tabsId);
        this.statsElement = document.getElementById('stats');

        this.sheets = {}; // { "Sheet1": [data], "Sheet2": [data] }
        this.currentSheetName = null;
        this.currentKeys = [];

        // ì´ë²¤íŠ¸ ìœ„ì„ ì„¤ì • (ì„±ëŠ¥ ìµœì í™”)
        this.setupEventDelegation();
    }

    // ì´ë²¤íŠ¸ ìœ„ì„ìœ¼ë¡œ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ëŒ€í­ ê°ì†Œ
    setupEventDelegation() {
        this.tableBody.addEventListener('blur', (e) => {
            if (e.target.tagName === 'TD' && e.target.contentEditable === 'true') {
                const rowIndex = e.target.parentElement.rowIndex - 1; // í—¤ë” ì œì™¸
                const cellIndex = e.target.cellIndex;
                const key = this.currentKeys[cellIndex];

                if (key && this.sheets[this.currentSheetName] && this.sheets[this.currentSheetName][rowIndex]) {
                    const value = e.target.textContent.trim();
                    this.sheets[this.currentSheetName][rowIndex][key] = isNaN(value) ? value : Number(value);
                }
            }
        }, true); // capture phase
    }

    // ì—¬ëŸ¬ ì‹œíŠ¸ ë°ì´í„° ë¡œë“œ
    loadSheets(sheetDataMap) {
        this.sheets = sheetDataMap;
        const sheetNames = Object.keys(this.sheets);
        if (sheetNames.length > 0) {
            this.switchSheet(sheetNames[0]);
        }
        this.renderTabs();
    }

    // ì‹œíŠ¸ ë³€ê²½
    switchSheet(sheetName) {
        this.currentSheetName = sheetName;
        this.renderGrid(this.sheets[sheetName]);
        this.renderTabs(); // íƒ­ í™œì„± ìƒíƒœ ì—…ë°ì´íŠ¸
    }

    // í˜„ì¬ ì‹œíŠ¸ ë°ì´í„° ì—…ë°ì´íŠ¸ (AI ê²°ê³¼ ë°˜ì˜ ë“±)
    updateCurrentSheetData(newData) {
        if (!this.currentSheetName) return;
        this.sheets[this.currentSheetName] = newData;
        this.renderGrid(newData);
    }

    getCurrentData() {
        return this.currentSheetName ? this.sheets[this.currentSheetName] : [];
    }

    // í™”ë©´ ê·¸ë¦¬ê¸° (í…Œì´ë¸”) - ì¦ë¶„ ë Œë”ë§ìœ¼ë¡œ ìµœì í™”
    renderGrid(data) {
        const startTime = performance.now();

        this.tableBody.innerHTML = '';
        this.headerRow.innerHTML = '';

        if (!data || data.length === 0) {
            this.tableBody.innerHTML = '<tr><td colspan="5">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            this.updateStats(0, 0, 0);
            return;
        }

        // í—¤ë” (Keys)
        this.currentKeys = Object.keys(data[0]);
        const headerFragment = document.createDocumentFragment();
        this.currentKeys.forEach(key => {
            let th = document.createElement('th');
            th.textContent = key;
            headerFragment.appendChild(th);
        });
        this.headerRow.appendChild(headerFragment);

        // ì¦ë¶„ ë Œë”ë§: ì²« ë°°ì¹˜ëŠ” ì‘ê²Œ, ì´í›„ëŠ” í¬ê²Œ
        let currentIndex = 0;
        let batchNumber = 0;

        const renderBatch = () => {
            // ì²« ë°°ì¹˜ëŠ” 20í–‰ìœ¼ë¡œ ë¹ ë¥¸ í”¼ë“œë°±, ì´í›„ëŠ” 200í–‰ì”©
            const BATCH_SIZE = batchNumber === 0 ? 20 : 200;
            const fragment = document.createDocumentFragment();
            const endIndex = Math.min(currentIndex + BATCH_SIZE, data.length);

            for (let rowIndex = currentIndex; rowIndex < endIndex; rowIndex++) {
                const row = data[rowIndex];
                const tr = document.createElement('tr');

                this.currentKeys.forEach(key => {
                    const td = document.createElement('td');
                    td.contentEditable = true;
                    const value = row[key];
                    td.textContent = value !== undefined && value !== null ? value : "";
                    tr.appendChild(td);
                });

                fragment.appendChild(tr);
            }

            this.tableBody.appendChild(fragment);
            currentIndex = endIndex;
            batchNumber++;

            if (currentIndex < data.length) {
                // setTimeoutìœ¼ë¡œ UI ë¸”ë¡ ë°©ì§€
                setTimeout(renderBatch, 0);
            } else {
                const endTime = performance.now();
                this.updateStats(data.length, this.currentKeys.length, endTime - startTime);
            }
        };

        renderBatch();
    }

    // ì„±ëŠ¥ í†µê³„ í‘œì‹œ
    updateStats(rows, cols, renderTime) {
        if (this.statsElement) {
            this.statsElement.textContent = `${rows.toLocaleString()}í–‰ Ã— ${cols}ì—´ (ë Œë”ë§: ${renderTime.toFixed(0)}ms)`;
        }
    }

    // í•˜ë‹¨ íƒ­ ê·¸ë¦¬ê¸° (ë¹ˆ ì‹œíŠ¸ë„ í‘œì‹œ)
    renderTabs() {
        this.tabsContainer.innerHTML = '';
        Object.keys(this.sheets).forEach(name => {
            const data = this.sheets[name];
            const isEmpty = !data || data.length === 0;

            let tab = document.createElement('div');
            tab.className = `sheet-tab ${name === this.currentSheetName ? 'active' : ''} ${isEmpty ? 'empty' : ''}`;
            tab.textContent = isEmpty ? `${name} (ë¹„ì–´ìˆìŒ)` : name;
            tab.onclick = () => this.switchSheet(name);
            this.tabsContainer.appendChild(tab);
        });
    }
}

/**
 * 2. ExcelIO: ë©€í‹° ì‹œíŠ¸ íŒŒì¼ ì…ì¶œë ¥ (ë¹ˆ ì‹œíŠ¸ ì²˜ë¦¬ ê°œì„ )
 */
class ExcelIO {
    constructor(gridManager) {
        this.grid = gridManager;
        this.fileInput = document.getElementById('fileInput');
        this.loadingOverlay = document.getElementById('file-loading-overlay');
        this.loadingMessage = document.getElementById('loading-message');
        this.fileInput.addEventListener('change', (e) => this.handleFile(e));
    }

    triggerImport() { this.fileInput.click(); }

    showLoading(message = 'íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...') {
        this.loadingMessage.textContent = message;
        this.loadingOverlay.classList.add('show');
    }

    hideLoading() {
        this.loadingOverlay.classList.remove('show');
    }

    async handleFile(e) {
        const file = e.target.files[0];
        if(!file) return;

        this.showLoading(`${file.name} íŒŒì¼ ë¡œë“œ ì¤‘...`);

        // ê°™ì€ íŒŒì¼ì„ ë‹¤ì‹œ ì„ íƒí•  ìˆ˜ ìˆë„ë¡ ì´ˆê¸°í™”
        e.target.value = '';

        // UI ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ ì•½ê°„ì˜ ì§€ì—°
        await new Promise(resolve => setTimeout(resolve, 50));

        const reader = new FileReader();
        reader.onload = async (event) => {
            try {
                this.showLoading('ë°ì´í„° íŒŒì‹± ì¤‘...');

                // UI ë¸”ë¡ ë°©ì§€ë¥¼ ìœ„í•´ setTimeout ì‚¬ìš©
                await new Promise(resolve => setTimeout(resolve, 10));

                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array' });

                this.showLoading(`${workbook.SheetNames.length}ê°œ ì‹œíŠ¸ ì²˜ë¦¬ ì¤‘...`);

                // ë¹„ë™ê¸°ë¡œ ì‹œíŠ¸ íŒŒì‹±
                const allSheetsData = {};
                for (let i = 0; i < workbook.SheetNames.length; i++) {
                    const sheetName = workbook.SheetNames[i];
                    const sheet = workbook.Sheets[sheetName];

                    // UI ë¸”ë¡ ë°©ì§€
                    if (i % 3 === 0) {
                        this.showLoading(`ì‹œíŠ¸ ì²˜ë¦¬ ì¤‘... (${i + 1}/${workbook.SheetNames.length})`);
                        await new Promise(resolve => setTimeout(resolve, 0));
                    }

                    const jsonData = XLSX.utils.sheet_to_json(sheet, { defval: "" });
                    allSheetsData[sheetName] = jsonData;
                }

                this.showLoading('í™”ë©´ ë Œë”ë§ ì¤‘...');
                await new Promise(resolve => setTimeout(resolve, 10));

                this.grid.loadSheets(allSheetsData);

                // ë Œë”ë§ì´ ì‹œì‘ëœ í›„ ë¡œë”© ìˆ¨ê¹€
                setTimeout(() => this.hideLoading(), 100);

            } catch (error) {
                console.error('íŒŒì¼ ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                this.hideLoading();
            }
        };

        reader.onerror = () => {
            alert('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            this.hideLoading();
        };

        reader.readAsArrayBuffer(file);
    }

    exportFile() {
        const wb = XLSX.utils.book_new();
        const sheets = this.grid.sheets;

        Object.keys(sheets).forEach(name => {
            const data = sheets[name];
            const ws = data && data.length > 0
                ? XLSX.utils.json_to_sheet(data)
                : XLSX.utils.aoa_to_sheet([]); // ë¹ˆ ì‹œíŠ¸ ì²˜ë¦¬
            XLSX.utils.book_append_sheet(wb, ws, name);
        });

        XLSX.writeFile(wb, "K-IFRS_Data_Validation_Result.xlsx");
    }
}

/**
 * 3. AIEngine: ì‹¤ì œ ChatGPT API ì—°ë™ (ë°ì´í„° ìƒ˜í”Œë§ & íˆìŠ¤í† ë¦¬ ì¶”ê°€)
 */
class AIEngine {
    constructor(gridManager) {
        this.grid = gridManager;
        this.input = document.getElementById('ai-prompt');
        this.apiKeyInput = document.getElementById('api-key');
        this.loading = document.getElementById('loading');
        this.historyContainer = document.getElementById('ai-history');
        this.history = [];
    }

    async processCommand() {
        const apiKey = this.apiKeyInput.value.trim();
        const prompt = this.input.value.trim();
        const currentData = this.grid.getCurrentData();

        if (!apiKey) {
            alert("OpenAI API Keyë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }
        if (!prompt) {
            alert("ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }
        if (currentData.length === 0) {
            alert("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        this.setLoading(true);
        const startTime = Date.now();

        try {
            // ë°ì´í„° ìƒ˜í”Œë§: 1000í–‰ ì´ìƒì´ë©´ ì²˜ìŒ 500í–‰ + ë§ˆì§€ë§‰ 500í–‰ë§Œ ì „ì†¡
            let sampledData = currentData;
            let isSampled = false;
            const MAX_ROWS = 1000;

            if (currentData.length > MAX_ROWS) {
                const halfSize = Math.floor(MAX_ROWS / 2);
                sampledData = [
                    ...currentData.slice(0, halfSize),
                    ...currentData.slice(-halfSize)
                ];
                isSampled = true;
            }

            // AIì—ê²Œ ë³´ë‚¼ ë©”ì‹œì§€ êµ¬ì„±
            const messages = [
                {
                    role: "system",
                    content: "You are a helpful data assistant. Output ONLY valid JSON array representing the modified data based on the user's command. Do not explain. Maintain the same keys/structure unless asked to change."
                },
                {
                    role: "user",
                    content: `Here is the current dataset in JSON${isSampled ? ' (sampled from ' + currentData.length + ' rows)' : ''}:\n${JSON.stringify(sampledData)}\n\nCommand: ${prompt}\n\nProcessed Data (JSON):`
                }
            ];

            const response = await fetch("https://api.openai.com/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: "gpt-3.5-turbo",
                    messages: messages,
                    temperature: 0.1
                })
            });

            const result = await response.json();

            if (result.error) {
                throw new Error(result.error.message);
            }

            const content = result.choices[0].message.content;

            // JSON íŒŒì‹± ì‹œë„
            try {
                const newData = JSON.parse(content);
                if (Array.isArray(newData)) {
                    this.grid.updateCurrentSheetData(newData);

                    const elapsedTime = ((Date.now() - startTime) / 1000).toFixed(1);
                    const resultSummary = `${currentData.length}í–‰ â†’ ${newData.length}í–‰ (${elapsedTime}ì´ˆ)`;

                    this.addHistory(prompt, resultSummary, false);
                    this.input.value = ''; // ëª…ë ¹ì–´ ì…ë ¥ì°½ ì´ˆê¸°í™”
                } else {
                    throw new Error("AIê°€ ìœ íš¨í•œ ë°ì´í„° í˜•ì‹ì„ ë°˜í™˜í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                }
            } catch (e) {
                console.error("Parsing Error:", content);
                this.addHistory(prompt, "íŒŒì‹± ì‹¤íŒ¨: " + e.message, true);
                alert("AI ì‘ë‹µì„ ì²˜ë¦¬í•˜ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. AI íŒ¨ë„ì—ì„œ ìì„¸í•œ ë‚´ìš©ì„ í™•ì¸í•˜ì„¸ìš”.");
            }

        } catch (error) {
            console.error(error);
            this.addHistory(prompt, "ì˜¤ë¥˜: " + error.message, true);
            alert("ì˜¤ë¥˜ ë°œìƒ: " + error.message);
        } finally {
            this.setLoading(false);
        }
    }

    // AI íˆìŠ¤í† ë¦¬ ì¶”ê°€
    addHistory(command, result, isError = false) {
        const entry = {
            time: new Date().toLocaleString('ko-KR'),
            command,
            result,
            isError
        };

        this.history.unshift(entry); // ìµœì‹  í•­ëª©ì„ ìœ„ì— í‘œì‹œ

        // íˆìŠ¤í† ë¦¬ëŠ” ìµœëŒ€ 20ê°œê¹Œì§€ë§Œ ìœ ì§€
        if (this.history.length > 20) {
            this.history.pop();
        }

        this.renderHistory();
    }

    // AI íˆìŠ¤í† ë¦¬ ë Œë”ë§
    renderHistory() {
        if (!this.historyContainer) return;

        this.historyContainer.innerHTML = '';

        if (this.history.length === 0) {
            this.historyContainer.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">ì•„ì§ AI ì‘ì—… ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        this.history.forEach(entry => {
            const div = document.createElement('div');
            div.className = `ai-entry ${entry.isError ? 'ai-entry-error' : ''}`;

            div.innerHTML = `
                <div class="ai-entry-time">${entry.time}</div>
                <div class="ai-entry-command">${entry.command}</div>
                <div class="ai-entry-result">${entry.result}</div>
            `;

            this.historyContainer.appendChild(div);
        });
    }

    setLoading(isLoading) {
        this.loading.style.display = isLoading ? 'inline' : 'none';
        document.getElementById('ai-btn').disabled = isLoading;
    }
}

// ì•± ì´ˆê¸°í™” ë° ì‹¤í–‰
const app = (() => {
    const gridManager = new GridManager('#spreadsheet', '#sheet-tabs');
    const excelIO = new ExcelIO(gridManager);
    const aiEngine = new AIEngine(gridManager);
    const aiPanel = document.getElementById('ai-panel');
    const resizer = document.getElementById('ai-panel-resizer');

    // AI íŒ¨ë„ í† ê¸€ í•¨ìˆ˜
    const toggleAIPanel = () => {
        aiPanel.classList.toggle('collapsed');
    };

    // AI íŒ¨ë„ ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥
    let isResizing = false;
    let startX = 0;
    let startWidth = 0;

    resizer.addEventListener('mousedown', (e) => {
        isResizing = true;
        startX = e.clientX;
        startWidth = aiPanel.offsetWidth;
        document.body.classList.add('resizing');
        e.preventDefault();
    });

    document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;

        const diff = startX - e.clientX; // ì™¼ìª½ìœ¼ë¡œ ë“œë˜ê·¸í•˜ë©´ ì–‘ìˆ˜
        const newWidth = startWidth + diff;

        // ìµœì†Œ/ìµœëŒ€ ë„ˆë¹„ ì œí•œ
        if (newWidth >= 200 && newWidth <= 600) {
            aiPanel.style.width = newWidth + 'px';
        }
    });

    document.addEventListener('mouseup', () => {
        if (isResizing) {
            isResizing = false;
            document.body.classList.remove('resizing');
        }
    });

    // ì´ˆê¸° ë°ì´í„° ì—†ìŒ - ì‚¬ìš©ìê°€ ì—‘ì…€ íŒŒì¼ì„ ì—´ì–´ì•¼ í•¨
    gridManager.loadSheets({});

    return { gridManager, excelIO, aiEngine, toggleAIPanel };
})();

</script>

</body>
</html>