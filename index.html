<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>K-IFRS ë°ì´í„° ê²€ì¦</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        /* Header & Toolbar */
        header { padding: 12px; background: #f3f3f3; border-bottom: 1px solid #ccc; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: space-between; }
        .toolbar-group { display: flex; gap: 8px; align-items: center; }

        /* Main Content Area (Grid + Side Panel) */
        #main-content { display: flex; flex: 1; overflow: hidden; }

        /* Grid Area */
        #grid-container { flex: 1; overflow: auto; position: relative; background: #fff; }
        table { border-collapse: collapse; min-width: 100%; font-size: 14px; }
        th, td { border: 1px solid #e0e0e0; min-width: 80px; padding: 6px; text-align: center; outline: none; }
        th { background: #f9f9f9; position: sticky; top: 0; z-index: 10; font-weight: 600; color: #555; border-bottom: 2px solid #ccc; }
        td:focus { border: 2px solid #107c41; background: #e8f5e9; }

        /* Sheet Tabs (Bottom) */
        #sheet-tabs { background: #e0e0e0; padding: 0; display: flex; overflow-x: auto; border-top: 1px solid #ccc; }
        .sheet-tab { padding: 8px 15px; cursor: pointer; background: #e0e0e0; border-right: 1px solid #ccc; font-size: 13px; user-select: none; }
        .sheet-tab.active { background: #fff; color: #107c41; font-weight: bold; border-bottom: 3px solid #107c41; }
        .sheet-tab:hover:not(.active) { background: #d0d0d0; }
        .sheet-tab.empty { color: #999; font-style: italic; }

        /* AI Side Panel */
        #ai-panel { width: 320px; min-width: 200px; max-width: 600px; border-left: 2px solid #ccc; background: #f9f9f9; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        #ai-panel.collapsed { width: 0; min-width: 0; border: none; }
        #ai-panel-resizer { width: 6px; height: 100%; position: absolute; left: 0; top: 0; cursor: col-resize; background: transparent; z-index: 100; }
        #ai-panel-resizer:hover { background: #107c41; opacity: 0.3; }
        #ai-panel-header { padding: 12px; background: #107c41; color: white; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        #ai-panel-toggle { background: transparent; border: none; color: white; cursor: pointer; font-size: 18px; padding: 4px; }
        #ai-history { flex: 1; overflow-y: auto; padding: 10px; }
        .ai-entry { background: white; margin-bottom: 10px; padding: 10px; border-radius: 6px; border-left: 4px solid #107c41; font-size: 13px; }
        .ai-entry-time { color: #666; font-size: 11px; margin-bottom: 4px; }
        .ai-entry-command { font-weight: bold; color: #107c41; margin-bottom: 6px; }
        .ai-entry-result { color: #333; }
        .ai-entry-error { border-left-color: #d32f2f; }
        .ai-entry-error .ai-entry-command { color: #d32f2f; }
        body.resizing { cursor: col-resize; user-select: none; }
        body.resizing * { cursor: col-resize !important; }

        /* AI & UI Components */
        .btn { padding: 8px 14px; cursor: pointer; background: #107c41; color: white; border: none; border-radius: 4px; font-weight: 500; transition: 0.2s; }
        .btn:hover { background: #0c5e31; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .btn-toggle { background: #666; padding: 6px 10px; font-size: 12px; }

        input[type="text"], input[type="password"] { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        #ai-prompt { width: 300px; }
        #api-key { width: 200px; }

        /* Loading Indicator */
        #loading { display: none; color: #107c41; font-weight: bold; margin-left: 10px; }

        /* Performance Stats */
        #stats { font-size: 11px; color: #666; padding: 4px 12px; background: #fff; border-radius: 4px; }

        /* File Loading Overlay */
        #file-loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center; }
        #file-loading-overlay.show { display: flex; }
        .loading-content { background: white; padding: 30px 50px; border-radius: 8px; text-align: center; }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #107c41; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Menu Bar */
        #menu-bar { background: #f8f8f8; border-bottom: 1px solid #d0d0d0; display: flex; gap: 2px; padding: 4px 8px; }
        .menu-item { padding: 6px 12px; cursor: pointer; border-radius: 3px; font-size: 13px; position: relative; user-select: none; }
        .menu-item:hover { background: #e0e0e0; }
        .menu-item.active { background: #d0d0d0; }

        /* Dropdown Menu */
        .dropdown-menu { display: none; position: absolute; top: 100%; left: 0; background: white; border: 1px solid #ccc; box-shadow: 0 2px 8px rgba(0,0,0,0.15); min-width: 180px; z-index: 1000; }
        .dropdown-menu.show { display: block; }
        .menu-option { padding: 8px 16px; cursor: pointer; font-size: 13px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f0f0f0; }
        .menu-option:last-child { border-bottom: none; }
        .menu-option:hover { background: #f5f5f5; }
        .menu-option.disabled { color: #999; cursor: not-allowed; }
        .menu-option.disabled:hover { background: white; }
        .menu-shortcut { color: #999; font-size: 11px; margin-left: 20px; }
        .menu-separator { height: 1px; background: #e0e0e0; margin: 4px 0; }

        /* Context Menu */
        #context-menu { display: none; position: fixed; background: white; border: 1px solid #ccc; box-shadow: 0 2px 8px rgba(0,0,0,0.15); min-width: 160px; z-index: 10000; }
        #context-menu.show { display: block; }

        /* Toolbar */
        #toolbar { background: #f3f3f3; border-bottom: 1px solid #d0d0d0; padding: 6px 8px; display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        .toolbar-section { display: flex; gap: 4px; align-items: center; padding: 0 8px; border-right: 1px solid #d0d0d0; }
        .toolbar-section:last-child { border-right: none; }
        .toolbar-btn { padding: 5px 10px; cursor: pointer; background: white; border: 1px solid #ccc; border-radius: 3px; font-size: 12px; transition: 0.2s; }
        .toolbar-btn:hover { background: #e8e8e8; }
        .toolbar-btn:active { background: #d0d0d0; }
        .toolbar-btn.disabled { opacity: 0.5; cursor: not-allowed; }
        .color-picker-btn { width: 30px; height: 26px; border: 1px solid #ccc; border-radius: 3px; cursor: pointer; position: relative; }
        .color-picker-btn input[type="color"] { position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; }

        /* Row/Column Headers */
        .row-header, .col-header { background: #f0f0f0; font-weight: bold; color: #666; cursor: pointer; user-select: none; }
        .row-header:hover, .col-header:hover { background: #e0e0e0; }
        .row-header.selected, .col-header.selected { background: #d0d0d0; }
        .corner-cell { background: #f0f0f0; cursor: pointer; }

        /* Cell Styling */
        td.bold { font-weight: bold; }
        td.italic { font-style: italic; }
        td.underline { text-decoration: underline; }

        /* Selection */
        td.selected { background: #cce5ff !important; }
        tr.selected td { background: #e6f2ff !important; }

        /* Filter UI */
        .filter-icon { cursor: pointer; margin-left: 5px; color: #666; }
        .filter-icon:hover { color: #107c41; }
        .filter-popup { display: none; position: absolute; background: white; border: 1px solid #ccc; box-shadow: 0 2px 8px rgba(0,0,0,0.15); min-width: 200px; padding: 10px; z-index: 1000; }
        .filter-popup.show { display: block; }
        .filter-option { padding: 4px 0; }
        .filter-option input { margin-right: 5px; }

        /* Search Dialog */
        #search-dialog, #validation-dialog { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border: 1px solid #ccc; box-shadow: 0 4px 16px rgba(0,0,0,0.2); padding: 20px; min-width: 400px; z-index: 10000; }
        #search-dialog.show, #validation-dialog.show { display: block; }
        .dialog-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 9999; }
        .dialog-overlay.show { display: block; }
        .dialog-title { font-size: 16px; font-weight: bold; margin-bottom: 15px; }
        .dialog-row { margin-bottom: 10px; }
        .dialog-label { display: inline-block; width: 100px; }
        .dialog-input { width: 250px; padding: 5px; border: 1px solid #ccc; border-radius: 3px; }
        .dialog-buttons { margin-top: 15px; text-align: right; }
        .dialog-btn { padding: 6px 15px; margin-left: 5px; cursor: pointer; border: none; border-radius: 3px; }
        .dialog-btn-primary { background: #107c41; color: white; }
        .dialog-btn-secondary { background: #e0e0e0; }

        /* Formula Bar */
        #formula-bar { background: #fff; border-bottom: 1px solid #d0d0d0; padding: 5px 8px; display: flex; align-items: center; gap: 8px; }
        #formula-input { flex: 1; padding: 5px; border: 1px solid #ccc; border-radius: 3px; font-family: 'Consolas', monospace; }
        #cell-reference { font-weight: bold; min-width: 80px; }
    </style>
</head>
<body>

<!-- Menu Bar -->
<div id="menu-bar">
    <div class="menu-item" data-menu="file">íŒŒì¼</div>
    <div class="menu-item" data-menu="edit">í¸ì§‘</div>
    <div class="menu-item" data-menu="insert">ì‚½ì…</div>
    <div class="menu-item" data-menu="format">ì„œì‹</div>
    <div class="menu-item" data-menu="data">ë°ì´í„°</div>
    <div class="menu-item" data-menu="ai">AI</div>
</div>

<!-- Toolbar -->
<div id="toolbar">
    <div class="toolbar-section">
        <input type="file" id="fileInput" hidden />
        <button class="toolbar-btn" onclick="app.excelIO.triggerImport()">ğŸ“‚ ì—´ê¸°</button>
        <button class="toolbar-btn" onclick="app.excelIO.exportFile()">ğŸ’¾ ì €ì¥</button>
    </div>

    <div class="toolbar-section">
        <button class="toolbar-btn" id="undo-btn" onclick="app.commandManager.undo()">â†¶ ì‹¤í–‰ ì·¨ì†Œ</button>
        <button class="toolbar-btn" id="redo-btn" onclick="app.commandManager.redo()">â†· ë‹¤ì‹œ ì‹¤í–‰</button>
    </div>

    <div class="toolbar-section">
        <button class="toolbar-btn" onclick="app.cellFormatter.toggleBold()"><b>B</b></button>
        <button class="toolbar-btn" onclick="app.cellFormatter.toggleItalic()"><i>I</i></button>
        <button class="toolbar-btn" onclick="app.cellFormatter.toggleUnderline()"><u>U</u></button>
        <div class="color-picker-btn" title="í…ìŠ¤íŠ¸ ìƒ‰ìƒ">
            <input type="color" id="text-color-picker" onchange="app.cellFormatter.setTextColor(this.value)">
            A
        </div>
        <div class="color-picker-btn" title="ë°°ê²½ìƒ‰">
            <input type="color" id="bg-color-picker" onchange="app.cellFormatter.setBackgroundColor(this.value)">
            ğŸ¨
        </div>
    </div>

    <div class="toolbar-section">
        <button class="toolbar-btn" onclick="app.sortManager.sortAscending()">â†‘ ì˜¤ë¦„ì°¨ìˆœ</button>
        <button class="toolbar-btn" onclick="app.sortManager.sortDescending()">â†“ ë‚´ë¦¼ì°¨ìˆœ</button>
        <button class="toolbar-btn" onclick="app.filterManager.toggleFilter()">ğŸ” í•„í„°</button>
    </div>

    <div class="toolbar-section">
        <button class="toolbar-btn" onclick="app.searchManager.showSearchDialog()">ğŸ” ê²€ìƒ‰</button>
        <button class="toolbar-btn" onclick="app.validationManager.showDialog()">âœ“ ìœ íš¨ì„±</button>
    </div>

    <div class="toolbar-section">
        <input type="password" id="api-key" placeholder="API Key" style="width: 150px;" />
        <input type="text" id="ai-prompt" placeholder="AI ëª…ë ¹ì–´..." style="width: 250px;" />
        <button class="toolbar-btn" id="ai-btn" onclick="app.aiEngine.processCommand()">âœ¨ AI ì‹¤í–‰</button>
        <button class="toolbar-btn" onclick="app.toggleAIPanel()">AI íŒ¨ë„</button>
        <span id="loading">ì²˜ë¦¬ì¤‘... ğŸ¤–</span>
    </div>

    <div class="toolbar-section">
        <span id="stats"></span>
    </div>
</div>

<!-- Formula Bar -->
<div id="formula-bar">
    <span id="cell-reference">-</span>
    <input type="text" id="formula-input" placeholder="ìˆ˜ì‹ ë˜ëŠ” ê°’ ì…ë ¥ (ì˜ˆ: =SUM(A1:A10))" />
</div>

<div id="main-content">
    <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
        <div id="grid-container">
            <table id="spreadsheet">
                <thead><tr id="header-row"></tr></thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
        <div id="sheet-tabs"></div>
    </div>

    <div id="ai-panel">
        <div id="ai-panel-resizer"></div>
        <div id="ai-panel-header">
            <span>AI ì‘ì—… íˆìŠ¤í† ë¦¬</span>
            <button id="ai-panel-toggle" onclick="app.toggleAIPanel()">âœ•</button>
        </div>
        <div id="ai-history"></div>
    </div>
</div>

<div id="file-loading-overlay">
    <div class="loading-content">
        <div class="loading-spinner"></div>
        <div id="loading-message">íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
</div>

<!-- Context Menu -->
<div id="context-menu"></div>

<!-- Search Dialog -->
<div class="dialog-overlay" id="search-overlay"></div>
<div id="search-dialog">
    <div class="dialog-title">ê²€ìƒ‰ ë° ë°”ê¾¸ê¸°</div>
    <div class="dialog-row">
        <label class="dialog-label">ê²€ìƒ‰:</label>
        <input type="text" id="search-find" class="dialog-input" />
    </div>
    <div class="dialog-row">
        <label class="dialog-label">ë°”ê¾¸ê¸°:</label>
        <input type="text" id="search-replace" class="dialog-input" />
    </div>
    <div class="dialog-row">
        <label class="dialog-label"></label>
        <input type="checkbox" id="search-case-sensitive" />
        <label>ëŒ€ì†Œë¬¸ì êµ¬ë¶„</label>
    </div>
    <div class="dialog-buttons">
        <button class="dialog-btn dialog-btn-primary" onclick="app.searchManager.findNext()">ë‹¤ìŒ ì°¾ê¸°</button>
        <button class="dialog-btn dialog-btn-primary" onclick="app.searchManager.replaceOne()">ë°”ê¾¸ê¸°</button>
        <button class="dialog-btn dialog-btn-primary" onclick="app.searchManager.replaceAll()">ëª¨ë‘ ë°”ê¾¸ê¸°</button>
        <button class="dialog-btn dialog-btn-secondary" onclick="app.searchManager.hideSearchDialog()">ë‹«ê¸°</button>
    </div>
</div>

<!-- Validation Dialog -->
<div class="dialog-overlay" id="validation-overlay"></div>
<div id="validation-dialog">
    <div class="dialog-title">ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬</div>
    <div class="dialog-row">
        <label class="dialog-label">ê·œì¹™ ìœ í˜•:</label>
        <select id="validation-type" class="dialog-input">
            <option value="number">ìˆ«ì</option>
            <option value="text">í…ìŠ¤íŠ¸ ê¸¸ì´</option>
            <option value="list">ëª©ë¡</option>
            <option value="date">ë‚ ì§œ</option>
        </select>
    </div>
    <div class="dialog-row">
        <label class="dialog-label">ìµœì†Œê°’:</label>
        <input type="text" id="validation-min" class="dialog-input" />
    </div>
    <div class="dialog-row">
        <label class="dialog-label">ìµœëŒ€ê°’:</label>
        <input type="text" id="validation-max" class="dialog-input" />
    </div>
    <div class="dialog-row">
        <label class="dialog-label">ëª©ë¡ (ì½¤ë§ˆ êµ¬ë¶„):</label>
        <input type="text" id="validation-list" class="dialog-input" placeholder="ì˜ˆ: ìŠ¹ì¸,ëŒ€ê¸°,ê±°ë¶€" />
    </div>
    <div class="dialog-buttons">
        <button class="dialog-btn dialog-btn-primary" onclick="app.validationManager.apply()">ì ìš©</button>
        <button class="dialog-btn dialog-btn-secondary" onclick="app.validationManager.hideDialog()">ì·¨ì†Œ</button>
    </div>
</div>

<script>
/**
 * 0. Command Pattern for Undo/Redo
 */
class CommandManager {
    constructor() {
        this.history = [];
        this.currentIndex = -1;
        this.maxHistory = 50;
    }

    execute(command) {
        // í˜„ì¬ ìœ„ì¹˜ ì´í›„ì˜ íˆìŠ¤í† ë¦¬ ì œê±°
        this.history = this.history.slice(0, this.currentIndex + 1);

        command.execute();
        this.history.push(command);
        this.currentIndex++;

        // íˆìŠ¤í† ë¦¬ í¬ê¸° ì œí•œ
        if (this.history.length > this.maxHistory) {
            this.history.shift();
            this.currentIndex--;
        }

        this.updateButtons();
    }

    undo() {
        if (this.canUndo()) {
            const command = this.history[this.currentIndex];
            command.undo();
            this.currentIndex--;
            this.updateButtons();
        }
    }

    redo() {
        if (this.canRedo()) {
            this.currentIndex++;
            const command = this.history[this.currentIndex];
            command.execute();
            this.updateButtons();
        }
    }

    canUndo() {
        return this.currentIndex >= 0;
    }

    canRedo() {
        return this.currentIndex < this.history.length - 1;
    }

    updateButtons() {
        const undoBtn = document.getElementById('undo-btn');
        const redoBtn = document.getElementById('redo-btn');
        if (undoBtn) undoBtn.classList.toggle('disabled', !this.canUndo());
        if (redoBtn) redoBtn.classList.toggle('disabled', !this.canRedo());
    }

    clear() {
        this.history = [];
        this.currentIndex = -1;
        this.updateButtons();
    }
}

/**
 * 1. Context Menu Manager
 */
class ContextMenuManager {
    constructor(gridManager) {
        this.grid = gridManager;
        this.menu = document.getElementById('context-menu');
        this.currentTarget = null;
        this.setupEvents();
    }

    setupEvents() {
        document.addEventListener('contextmenu', (e) => {
            const target = e.target;
            if (target.tagName === 'TD' || target.classList.contains('row-header') || target.classList.contains('col-header')) {
                e.preventDefault();
                this.show(e, target);
            } else {
                this.hide();
            }
        });

        document.addEventListener('click', () => this.hide());
    }

    show(event, target) {
        this.currentTarget = target;
        this.menu.innerHTML = '';

        if (target.tagName === 'TD') {
            this.buildCellMenu();
        } else if (target.classList.contains('row-header')) {
            this.buildRowMenu();
        } else if (target.classList.contains('col-header')) {
            this.buildColumnMenu();
        }

        this.menu.style.left = event.pageX + 'px';
        this.menu.style.top = event.pageY + 'px';
        this.menu.classList.add('show');
    }

    hide() {
        this.menu.classList.remove('show');
    }

    buildCellMenu() {
        this.addOption('ë³µì‚¬', () => this.grid.copyCells());
        this.addOption('ë¶™ì—¬ë„£ê¸°', () => this.grid.pasteCells());
        this.addSeparator();
        this.addOption('í–‰ ì‚½ì…', () => app.rowColumnManager.insertRow());
        this.addOption('í–‰ ì‚­ì œ', () => app.rowColumnManager.deleteRow());
        this.addSeparator();
        this.addOption('ì—´ ì‚½ì…', () => app.rowColumnManager.insertColumn());
        this.addOption('ì—´ ì‚­ì œ', () => app.rowColumnManager.deleteColumn());
    }

    buildRowMenu() {
        this.addOption('ìœ„ì— í–‰ ì‚½ì…', () => app.rowColumnManager.insertRow());
        this.addOption('í–‰ ì‚­ì œ', () => app.rowColumnManager.deleteRow());
    }

    buildColumnMenu() {
        this.addOption('ì™¼ìª½ì— ì—´ ì‚½ì…', () => app.rowColumnManager.insertColumn());
        this.addOption('ì—´ ì‚­ì œ', () => app.rowColumnManager.deleteColumn());
    }

    addOption(text, callback) {
        const option = document.createElement('div');
        option.className = 'menu-option';
        option.textContent = text;
        option.onclick = () => {
            callback();
            this.hide();
        };
        this.menu.appendChild(option);
    }

    addSeparator() {
        const sep = document.createElement('div');
        sep.className = 'menu-separator';
        this.menu.appendChild(sep);
    }
}

/**
 * 2. Cell Formatter
 */
class CellFormatter {
    constructor(gridManager) {
        this.grid = gridManager;
        this.selectedCells = [];
    }

    getSelectedCells() {
        return Array.from(document.querySelectorAll('td.selected'));
    }

    toggleBold() {
        const cells = this.getSelectedCells();
        cells.forEach(cell => cell.classList.toggle('bold'));
    }

    toggleItalic() {
        const cells = this.getSelectedCells();
        cells.forEach(cell => cell.classList.toggle('italic'));
    }

    toggleUnderline() {
        const cells = this.getSelectedCells();
        cells.forEach(cell => cell.classList.toggle('underline'));
    }

    setTextColor(color) {
        const cells = this.getSelectedCells();
        cells.forEach(cell => cell.style.color = color);
    }

    setBackgroundColor(color) {
        const cells = this.getSelectedCells();
        cells.forEach(cell => cell.style.backgroundColor = color);
    }
}

/**
 * 3. Row/Column Manager
 */
class RowColumnManager {
    constructor(gridManager) {
        this.grid = gridManager;
    }

    insertRow() {
        const data = this.grid.getCurrentData();
        if (!data || data.length === 0) {
            alert('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        const newRow = {};
        this.grid.currentKeys.forEach(key => newRow[key] = '');

        data.push(newRow);
        this.grid.renderGrid(data);
    }

    deleteRow() {
        const selectedRow = document.querySelector('tr.selected');
        if (!selectedRow) {
            alert('ì‚­ì œí•  í–‰ì„ ì„ íƒí•˜ì„¸ìš”.');
            return;
        }

        const rowIndex = selectedRow.rowIndex - 1; // í—¤ë” ì œì™¸
        const data = this.grid.getCurrentData();

        if (confirm(`${rowIndex + 1}ë²ˆì§¸ í–‰ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            data.splice(rowIndex, 1);
            this.grid.updateCurrentSheetData(data);
        }
    }

    insertColumn() {
        const data = this.grid.getCurrentData();
        if (!data || data.length === 0) {
            alert('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        const newColName = prompt('ìƒˆ ì—´ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', 'ìƒˆì—´' + (this.grid.currentKeys.length + 1));
        if (!newColName) return;

        data.forEach(row => row[newColName] = '');
        this.grid.renderGrid(data);
    }

    deleteColumn() {
        const selectedHeader = document.querySelector('th.selected');
        if (!selectedHeader) {
            alert('ì‚­ì œí•  ì—´ì„ ì„ íƒí•˜ì„¸ìš”.');
            return;
        }

        const colName = selectedHeader.textContent;

        if (confirm(`"${colName}" ì—´ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            const data = this.grid.getCurrentData();
            data.forEach(row => delete row[colName]);
            this.grid.renderGrid(data);
        }
    }
}

/**
 * 4. Sort Manager
 */
class SortManager {
    constructor(gridManager) {
        this.grid = gridManager;
    }

    sortAscending() {
        this.sort(true);
    }

    sortDescending() {
        this.sort(false);
    }

    sort(ascending = true) {
        const selectedHeader = document.querySelector('th.selected');
        if (!selectedHeader) {
            alert('ì •ë ¬í•  ì—´ì„ ì„ íƒí•˜ì„¸ìš”.');
            return;
        }

        const colName = selectedHeader.textContent;
        const data = this.grid.getCurrentData();

        data.sort((a, b) => {
            const valA = a[colName];
            const valB = b[colName];

            // ìˆ«ì ë¹„êµ
            if (!isNaN(valA) && !isNaN(valB)) {
                return ascending ? valA - valB : valB - valA;
            }

            // ë¬¸ìì—´ ë¹„êµ
            const strA = String(valA || '');
            const strB = String(valB || '');
            return ascending ? strA.localeCompare(strB) : strB.localeCompare(strA);
        });

        this.grid.updateCurrentSheetData(data);
    }
}

/**
 * 5. Filter Manager
 */
class FilterManager {
    constructor(gridManager) {
        this.grid = gridManager;
        this.filterEnabled = false;
        this.filteredData = null;
        this.originalData = null;
    }

    toggleFilter() {
        this.filterEnabled = !this.filterEnabled;

        if (this.filterEnabled) {
            this.showFilterIcons();
            alert('í•„í„°ê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ì—´ í—¤ë”ì˜ í•„í„° ì•„ì´ì½˜ì„ í´ë¦­í•˜ì„¸ìš”.');
        } else {
            this.clearFilter();
        }
    }

    showFilterIcons() {
        // í—¤ë”ì— í•„í„° ì•„ì´ì½˜ ì¶”ê°€
        const headers = document.querySelectorAll('#header-row th');
        headers.forEach(th => {
            if (!th.querySelector('.filter-icon')) {
                const icon = document.createElement('span');
                icon.className = 'filter-icon';
                icon.textContent = 'â–¼';
                icon.onclick = (e) => {
                    e.stopPropagation();
                    this.showFilterPopup(th);
                };
                th.appendChild(icon);
            }
        });
    }

    showFilterPopup(headerElement) {
        const colName = headerElement.textContent.replace('â–¼', '').trim();
        const data = this.grid.getCurrentData();

        // ê³ ìœ  ê°’ ì¶”ì¶œ
        const uniqueValues = [...new Set(data.map(row => row[colName]))].sort();

        // íŒì—… ìƒì„±
        const popup = document.createElement('div');
        popup.className = 'filter-popup show';
        popup.style.left = headerElement.offsetLeft + 'px';
        popup.style.top = (headerElement.offsetTop + headerElement.offsetHeight) + 'px';

        popup.innerHTML = '<div><strong>ê°’ ì„ íƒ:</strong></div>';

        // "ì „ì²´ ì„ íƒ" ì˜µì…˜
        const allOption = document.createElement('div');
        allOption.className = 'filter-option';
        allOption.innerHTML = `<input type="checkbox" checked onchange="app.filterManager.toggleAllFilters(this, '${colName}')"> (ì „ì²´ ì„ íƒ)`;
        popup.appendChild(allOption);

        // ê° ê°’ì— ëŒ€í•œ ì²´í¬ë°•ìŠ¤
        uniqueValues.forEach(value => {
            const option = document.createElement('div');
            option.className = 'filter-option';
            option.innerHTML = `<input type="checkbox" checked data-value="${value}" data-col="${colName}"> ${value}`;
            popup.appendChild(option);
        });

        // ì ìš© ë²„íŠ¼
        const applyBtn = document.createElement('button');
        applyBtn.className = 'toolbar-btn';
        applyBtn.textContent = 'ì ìš©';
        applyBtn.style.marginTop = '10px';
        applyBtn.onclick = () => {
            this.applyFilter(popup, colName);
            document.body.removeChild(popup);
        };
        popup.appendChild(applyBtn);

        // ê¸°ì¡´ íŒì—… ì œê±°
        document.querySelectorAll('.filter-popup').forEach(p => p.remove());

        document.body.appendChild(popup);

        // ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        setTimeout(() => {
            document.addEventListener('click', function closePopup(e) {
                if (!popup.contains(e.target)) {
                    popup.remove();
                    document.removeEventListener('click', closePopup);
                }
            });
        }, 100);
    }

    toggleAllFilters(checkbox, colName) {
        const popup = checkbox.closest('.filter-popup');
        const checkboxes = popup.querySelectorAll(`input[data-col="${colName}"]`);
        checkboxes.forEach(cb => cb.checked = checkbox.checked);
    }

    applyFilter(popup, colName) {
        const checkedValues = Array.from(popup.querySelectorAll(`input[data-col="${colName}"]:checked`))
            .map(cb => cb.dataset.value);

        const data = this.grid.getCurrentData();
        const filtered = data.filter(row => checkedValues.includes(String(row[colName])));

        this.grid.renderGrid(filtered);
    }

    clearFilter() {
        // í•„í„° ì•„ì´ì½˜ ì œê±°
        document.querySelectorAll('.filter-icon').forEach(icon => icon.remove());

        // ì›ë³¸ ë°ì´í„°ë¡œ ë³µì›
        if (this.originalData) {
            this.grid.renderGrid(this.originalData);
            this.originalData = null;
        }
    }
}

/**
 * 6. Search Manager
 */
class SearchManager {
    constructor(gridManager) {
        this.grid = gridManager;
        this.currentMatchIndex = -1;
        this.matches = [];
    }

    showSearchDialog() {
        document.getElementById('search-overlay').classList.add('show');
        document.getElementById('search-dialog').classList.add('show');
        document.getElementById('search-find').focus();
    }

    hideSearchDialog() {
        document.getElementById('search-overlay').classList.remove('show');
        document.getElementById('search-dialog').classList.remove('show');
    }

    findNext() {
        const searchText = document.getElementById('search-find').value;
        const caseSensitive = document.getElementById('search-case-sensitive').checked;

        if (!searchText) {
            alert('ê²€ìƒ‰í•  í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
            return;
        }

        // ëª¨ë“  ì…€ì—ì„œ ê²€ìƒ‰
        const cells = Array.from(document.querySelectorAll('#table-body td'));
        this.matches = cells.filter(cell => {
            const cellText = cell.textContent;
            return caseSensitive
                ? cellText.includes(searchText)
                : cellText.toLowerCase().includes(searchText.toLowerCase());
        });

        if (this.matches.length === 0) {
            alert('ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        // ë‹¤ìŒ ì¼ì¹˜ í•­ëª©ìœ¼ë¡œ ì´ë™
        this.currentMatchIndex = (this.currentMatchIndex + 1) % this.matches.length;
        const match = this.matches[this.currentMatchIndex];

        // ì„ íƒ í•´ì œ
        document.querySelectorAll('td.selected').forEach(td => td.classList.remove('selected'));

        // ì¼ì¹˜ í•­ëª© ì„ íƒ ë° ìŠ¤í¬ë¡¤
        match.classList.add('selected');
        match.scrollIntoView({ behavior: 'smooth', block: 'center' });

        alert(`${this.currentMatchIndex + 1}/${this.matches.length} ì°¾ìŒ`);
    }

    replaceOne() {
        if (this.matches.length === 0) {
            alert('ë¨¼ì € "ë‹¤ìŒ ì°¾ê¸°"ë¥¼ í´ë¦­í•˜ì„¸ìš”.');
            return;
        }

        const replaceText = document.getElementById('search-replace').value;
        const currentCell = this.matches[this.currentMatchIndex];

        if (currentCell) {
            currentCell.textContent = replaceText;

            // ë°ì´í„° ì—…ë°ì´íŠ¸
            const rowIndex = currentCell.parentElement.rowIndex - 1;
            const cellIndex = currentCell.cellIndex;
            const key = this.grid.currentKeys[cellIndex];
            if (key && this.grid.sheets[this.grid.currentSheetName] && this.grid.sheets[this.grid.currentSheetName][rowIndex]) {
                this.grid.sheets[this.grid.currentSheetName][rowIndex][key] = isNaN(replaceText) ? replaceText : Number(replaceText);
            }

            alert('ë°”ê¾¸ê¸° ì™„ë£Œ');
        }
    }

    replaceAll() {
        const searchText = document.getElementById('search-find').value;
        const replaceText = document.getElementById('search-replace').value;
        const caseSensitive = document.getElementById('search-case-sensitive').checked;

        if (!searchText) {
            alert('ê²€ìƒ‰í•  í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
            return;
        }

        let count = 0;
        const cells = Array.from(document.querySelectorAll('#table-body td'));

        cells.forEach(cell => {
            const cellText = cell.textContent;
            const matches = caseSensitive
                ? cellText === searchText
                : cellText.toLowerCase() === searchText.toLowerCase();

            if (matches) {
                cell.textContent = replaceText;

                // ë°ì´í„° ì—…ë°ì´íŠ¸
                const rowIndex = cell.parentElement.rowIndex - 1;
                const cellIndex = cell.cellIndex;
                const key = this.grid.currentKeys[cellIndex];
                if (key && this.grid.sheets[this.grid.currentSheetName] && this.grid.sheets[this.grid.currentSheetName][rowIndex]) {
                    this.grid.sheets[this.grid.currentSheetName][rowIndex][key] = isNaN(replaceText) ? replaceText : Number(replaceText);
                }

                count++;
            }
        });

        alert(`${count}ê°œ í•­ëª©ì„ ë°”ê¿¨ìŠµë‹ˆë‹¤.`);
    }
}

/**
 * 7. Validation Manager
 */
class ValidationManager {
    constructor(gridManager) {
        this.grid = gridManager;
        this.rules = {}; // { cellId: { type, min, max, list } }
    }

    showDialog() {
        const selected = document.querySelector('td.selected');
        if (!selected) {
            alert('ìœ íš¨ì„± ê²€ì‚¬ë¥¼ ì ìš©í•  ì…€ì„ ì„ íƒí•˜ì„¸ìš”.');
            return;
        }

        document.getElementById('validation-overlay').classList.add('show');
        document.getElementById('validation-dialog').classList.add('show');
    }

    hideDialog() {
        document.getElementById('validation-overlay').classList.remove('show');
        document.getElementById('validation-dialog').classList.remove('show');
    }

    apply() {
        const selectedCells = document.querySelectorAll('td.selected');
        if (selectedCells.length === 0) {
            alert('ì…€ì„ ì„ íƒí•˜ì„¸ìš”.');
            return;
        }

        const type = document.getElementById('validation-type').value;
        const min = document.getElementById('validation-min').value;
        const max = document.getElementById('validation-max').value;
        const list = document.getElementById('validation-list').value;

        selectedCells.forEach(cell => {
            const cellId = `${cell.parentElement.rowIndex}-${cell.cellIndex}`;
            this.rules[cellId] = { type, min, max, list };

            // ì‹œê°ì  í‘œì‹œ
            cell.style.border = '2px solid #2196F3';
            cell.title = `ìœ íš¨ì„± ê²€ì‚¬: ${type}`;

            // blur ì´ë²¤íŠ¸ë¡œ ê²€ì¦
            cell.addEventListener('blur', () => this.validate(cell, cellId));
        });

        this.hideDialog();
        alert('ìœ íš¨ì„± ê²€ì‚¬ ê·œì¹™ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    validate(cell, cellId) {
        const rule = this.rules[cellId];
        if (!rule) return true;

        const value = cell.textContent.trim();

        switch (rule.type) {
            case 'number':
                const num = Number(value);
                if (isNaN(num)) {
                    alert('ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                    cell.style.backgroundColor = '#ffebee';
                    return false;
                }
                if (rule.min && num < Number(rule.min)) {
                    alert(`ìµœì†Œê°’ì€ ${rule.min}ì…ë‹ˆë‹¤.`);
                    cell.style.backgroundColor = '#ffebee';
                    return false;
                }
                if (rule.max && num > Number(rule.max)) {
                    alert(`ìµœëŒ€ê°’ì€ ${rule.max}ì…ë‹ˆë‹¤.`);
                    cell.style.backgroundColor = '#ffebee';
                    return false;
                }
                break;

            case 'text':
                if (rule.min && value.length < Number(rule.min)) {
                    alert(`ìµœì†Œ ${rule.min}ì ì´ìƒ ì…ë ¥í•˜ì„¸ìš”.`);
                    cell.style.backgroundColor = '#ffebee';
                    return false;
                }
                if (rule.max && value.length > Number(rule.max)) {
                    alert(`ìµœëŒ€ ${rule.max}ìê¹Œì§€ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
                    cell.style.backgroundColor = '#ffebee';
                    return false;
                }
                break;

            case 'list':
                const allowedValues = rule.list.split(',').map(v => v.trim());
                if (!allowedValues.includes(value)) {
                    alert(`í—ˆìš©ëœ ê°’: ${rule.list}`);
                    cell.style.backgroundColor = '#ffebee';
                    return false;
                }
                break;
        }

        cell.style.backgroundColor = '';
        return true;
    }
}

/**
 * 8. Formula Engine
 */
class FormulaEngine {
    constructor(gridManager) {
        this.grid = gridManager;
        this.formulaBar = document.getElementById('formula-input');
        this.cellRef = document.getElementById('cell-reference');
        this.currentCell = null;
        this.setupEvents();
    }

    setupEvents() {
        // ì…€ ì„ íƒ ì‹œ ìˆ˜ì‹ ë°” ì—…ë°ì´íŠ¸
        document.addEventListener('click', (e) => {
            if (e.target.tagName === 'TD') {
                this.currentCell = e.target;
                this.updateFormulaBar();
            }
        });

        // ìˆ˜ì‹ ë°” ì—”í„° í‚¤
        this.formulaBar.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                this.applyFormula();
            }
        });
    }

    updateFormulaBar() {
        if (!this.currentCell) return;

        const rowIndex = this.currentCell.parentElement.rowIndex;
        const colIndex = this.currentCell.cellIndex;
        const colLetter = this.numberToColumn(colIndex);

        this.cellRef.textContent = `${colLetter}${rowIndex}`;
        this.formulaBar.value = this.currentCell.textContent;
    }

    applyFormula() {
        if (!this.currentCell) return;

        const formula = this.formulaBar.value.trim();

        if (formula.startsWith('=')) {
            const result = this.evaluateFormula(formula);
            this.currentCell.textContent = result;
        } else {
            this.currentCell.textContent = formula;
        }

        // ë°ì´í„° ì—…ë°ì´íŠ¸
        const rowIndex = this.currentCell.parentElement.rowIndex - 1;
        const cellIndex = this.currentCell.cellIndex;
        const key = this.grid.currentKeys[cellIndex];
        if (key && this.grid.sheets[this.grid.currentSheetName] && this.grid.sheets[this.grid.currentSheetName][rowIndex]) {
            const value = this.currentCell.textContent;
            this.grid.sheets[this.grid.currentSheetName][rowIndex][key] = isNaN(value) ? value : Number(value);
        }
    }

    evaluateFormula(formula) {
        try {
            // =SUM(A1:A10) í˜•ì‹ ì²˜ë¦¬
            if (formula.toUpperCase().startsWith('=SUM(')) {
                return this.handleSUM(formula);
            }
            // =AVERAGE(A1:A10)
            else if (formula.toUpperCase().startsWith('=AVERAGE(')) {
                return this.handleAVERAGE(formula);
            }
            // =COUNT(A1:A10)
            else if (formula.toUpperCase().startsWith('=COUNT(')) {
                return this.handleCOUNT(formula);
            }
            // =MAX(A1:A10)
            else if (formula.toUpperCase().startsWith('=MAX(')) {
                return this.handleMAX(formula);
            }
            // =MIN(A1:A10)
            else if (formula.toUpperCase().startsWith('=MIN(')) {
                return this.handleMIN(formula);
            }
            else {
                return '#ERROR: ì§€ì›í•˜ì§€ ì•ŠëŠ” ìˆ˜ì‹';
            }
        } catch (e) {
            return '#ERROR';
        }
    }

    handleSUM(formula) {
        const values = this.getRangeValues(formula);
        return values.reduce((sum, val) => sum + (Number(val) || 0), 0);
    }

    handleAVERAGE(formula) {
        const values = this.getRangeValues(formula);
        const sum = values.reduce((sum, val) => sum + (Number(val) || 0), 0);
        return values.length > 0 ? sum / values.length : 0;
    }

    handleCOUNT(formula) {
        const values = this.getRangeValues(formula);
        return values.filter(v => v !== '' && v !== null && v !== undefined).length;
    }

    handleMAX(formula) {
        const values = this.getRangeValues(formula).map(v => Number(v) || 0);
        return Math.max(...values);
    }

    handleMIN(formula) {
        const values = this.getRangeValues(formula).map(v => Number(v) || 0);
        return Math.min(...values);
    }

    getRangeValues(formula) {
        // "=SUM(A1:A10)" -> "A1:A10" ì¶”ì¶œ
        const match = formula.match(/\((.+)\)/);
        if (!match) return [];

        const range = match[1];

        // ë‹¨ì¼ ì…€ ë˜ëŠ” ë²”ìœ„
        if (range.includes(':')) {
            // ë²”ìœ„: A1:A10
            const [start, end] = range.split(':');
            return this.getCellsInRange(start, end);
        } else {
            // ë‹¨ì¼ ì…€: A1
            return [this.getCellValue(range)];
        }
    }

    getCellsInRange(start, end) {
        const values = [];
        const data = this.grid.getCurrentData();

        // ê°„ë‹¨ êµ¬í˜„: ì—´ ê¸°ì¤€ ë²”ìœ„ë§Œ ì§€ì› (A1:A10)
        const colName = this.grid.currentKeys[0]; // ì²« ë²ˆì§¸ ì—´
        const startRow = parseInt(start.replace(/[A-Z]/g, '')) - 1;
        const endRow = parseInt(end.replace(/[A-Z]/g, '')) - 1;

        for (let i = startRow; i <= endRow && i < data.length; i++) {
            values.push(data[i][colName]);
        }

        return values;
    }

    getCellValue(cellRef) {
        // ê°„ë‹¨ êµ¬í˜„
        return 0;
    }

    numberToColumn(num) {
        let column = '';
        while (num >= 0) {
            column = String.fromCharCode((num % 26) + 65) + column;
            num = Math.floor(num / 26) - 1;
        }
        return column;
    }
}

/**
 * 9. GridManager: ë©€í‹° ì‹œíŠ¸ ê´€ë¦¬ ë° ë Œë”ë§ (ìµœì í™” ë²„ì „)
 */
class GridManager {
    constructor(tableId, tabsId) {
        this.tableBody = document.querySelector(tableId + ' tbody');
        this.headerRow = document.querySelector(tableId + ' thead tr');
        this.tabsContainer = document.querySelector(tabsId);
        this.statsElement = document.getElementById('stats');

        this.sheets = {}; // { "Sheet1": [data], "Sheet2": [data] }
        this.currentSheetName = null;
        this.currentKeys = [];

        // ì´ë²¤íŠ¸ ìœ„ì„ ì„¤ì • (ì„±ëŠ¥ ìµœì í™”)
        this.setupEventDelegation();
    }

    // ì´ë²¤íŠ¸ ìœ„ì„ìœ¼ë¡œ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ëŒ€í­ ê°ì†Œ
    setupEventDelegation() {
        // ì…€ í¸ì§‘
        this.tableBody.addEventListener('blur', (e) => {
            if (e.target.tagName === 'TD' && e.target.contentEditable === 'true') {
                const rowIndex = e.target.parentElement.rowIndex - 1; // í—¤ë” ì œì™¸
                const cellIndex = e.target.cellIndex;
                const key = this.currentKeys[cellIndex];

                if (key && this.sheets[this.currentSheetName] && this.sheets[this.currentSheetName][rowIndex]) {
                    const value = e.target.textContent.trim();
                    this.sheets[this.currentSheetName][rowIndex][key] = isNaN(value) ? value : Number(value);
                }
            }
        }, true);

        // ì…€ ì„ íƒ
        this.tableBody.addEventListener('click', (e) => {
            if (e.target.tagName === 'TD') {
                // Ctrl í‚¤ë¥¼ ëˆ„ë¥´ì§€ ì•Šìœ¼ë©´ ê¸°ì¡´ ì„ íƒ í•´ì œ
                if (!e.ctrlKey) {
                    document.querySelectorAll('td.selected, tr.selected, th.selected').forEach(el => {
                        el.classList.remove('selected');
                    });
                }
                e.target.classList.toggle('selected');
            }
        });

        // í—¤ë” í´ë¦­ìœ¼ë¡œ ì—´ ì„ íƒ
        this.headerRow.addEventListener('click', (e) => {
            if (e.target.tagName === 'TH') {
                document.querySelectorAll('th.selected').forEach(th => th.classList.remove('selected'));
                e.target.classList.add('selected');
            }
        });
    }

    // ë³µì‚¬/ë¶™ì—¬ë„£ê¸° (ê°„ë‹¨ êµ¬í˜„)
    copyCells() {
        const cells = document.querySelectorAll('td.selected');
        if (cells.length === 0) return;

        const values = Array.from(cells).map(cell => cell.textContent);
        this.clipboard = values;
        alert(`${cells.length}ê°œ ì…€ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    }

    pasteCells() {
        if (!this.clipboard || this.clipboard.length === 0) {
            alert('ë³µì‚¬ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        const cells = document.querySelectorAll('td.selected');
        if (cells.length === 0) {
            alert('ë¶™ì—¬ë„£ì„ ì…€ì„ ì„ íƒí•˜ì„¸ìš”.');
            return;
        }

        cells.forEach((cell, i) => {
            if (i < this.clipboard.length) {
                cell.textContent = this.clipboard[i];
                // ë°ì´í„° ì—…ë°ì´íŠ¸
                const rowIndex = cell.parentElement.rowIndex - 1;
                const cellIndex = cell.cellIndex;
                const key = this.currentKeys[cellIndex];
                if (key && this.sheets[this.currentSheetName] && this.sheets[this.currentSheetName][rowIndex]) {
                    const value = this.clipboard[i];
                    this.sheets[this.currentSheetName][rowIndex][key] = isNaN(value) ? value : Number(value);
                }
            }
        });
    }

    // ì—¬ëŸ¬ ì‹œíŠ¸ ë°ì´í„° ë¡œë“œ
    loadSheets(sheetDataMap) {
        this.sheets = sheetDataMap;
        const sheetNames = Object.keys(this.sheets);
        if (sheetNames.length > 0) {
            this.switchSheet(sheetNames[0]);
        }
        this.renderTabs();
    }

    // ì‹œíŠ¸ ë³€ê²½
    switchSheet(sheetName) {
        this.currentSheetName = sheetName;
        this.renderGrid(this.sheets[sheetName]);
        this.renderTabs(); // íƒ­ í™œì„± ìƒíƒœ ì—…ë°ì´íŠ¸
    }

    // í˜„ì¬ ì‹œíŠ¸ ë°ì´í„° ì—…ë°ì´íŠ¸ (AI ê²°ê³¼ ë°˜ì˜ ë“±)
    updateCurrentSheetData(newData) {
        if (!this.currentSheetName) return;
        this.sheets[this.currentSheetName] = newData;
        this.renderGrid(newData);
    }

    getCurrentData() {
        return this.currentSheetName ? this.sheets[this.currentSheetName] : [];
    }

    // í™”ë©´ ê·¸ë¦¬ê¸° (í…Œì´ë¸”) - ì¦ë¶„ ë Œë”ë§ìœ¼ë¡œ ìµœì í™”
    renderGrid(data) {
        const startTime = performance.now();

        this.tableBody.innerHTML = '';
        this.headerRow.innerHTML = '';

        if (!data || data.length === 0) {
            this.tableBody.innerHTML = '<tr><td colspan="5">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            this.updateStats(0, 0, 0);
            return;
        }

        // í—¤ë” (Keys)
        this.currentKeys = Object.keys(data[0]);
        const headerFragment = document.createDocumentFragment();
        this.currentKeys.forEach(key => {
            let th = document.createElement('th');
            th.textContent = key;
            headerFragment.appendChild(th);
        });
        this.headerRow.appendChild(headerFragment);

        // ì¦ë¶„ ë Œë”ë§: ì²« ë°°ì¹˜ëŠ” ì‘ê²Œ, ì´í›„ëŠ” í¬ê²Œ
        let currentIndex = 0;
        let batchNumber = 0;

        const renderBatch = () => {
            // ì²« ë°°ì¹˜ëŠ” 20í–‰ìœ¼ë¡œ ë¹ ë¥¸ í”¼ë“œë°±, ì´í›„ëŠ” 200í–‰ì”©
            const BATCH_SIZE = batchNumber === 0 ? 20 : 200;
            const fragment = document.createDocumentFragment();
            const endIndex = Math.min(currentIndex + BATCH_SIZE, data.length);

            for (let rowIndex = currentIndex; rowIndex < endIndex; rowIndex++) {
                const row = data[rowIndex];
                const tr = document.createElement('tr');

                this.currentKeys.forEach(key => {
                    const td = document.createElement('td');
                    td.contentEditable = true;
                    const value = row[key];
                    td.textContent = value !== undefined && value !== null ? value : "";
                    tr.appendChild(td);
                });

                fragment.appendChild(tr);
            }

            this.tableBody.appendChild(fragment);
            currentIndex = endIndex;
            batchNumber++;

            if (currentIndex < data.length) {
                // setTimeoutìœ¼ë¡œ UI ë¸”ë¡ ë°©ì§€
                setTimeout(renderBatch, 0);
            } else {
                const endTime = performance.now();
                this.updateStats(data.length, this.currentKeys.length, endTime - startTime);
            }
        };

        renderBatch();
    }

    // ì„±ëŠ¥ í†µê³„ í‘œì‹œ
    updateStats(rows, cols, renderTime) {
        if (this.statsElement) {
            this.statsElement.textContent = `${rows.toLocaleString()}í–‰ Ã— ${cols}ì—´ (ë Œë”ë§: ${renderTime.toFixed(0)}ms)`;
        }
    }

    // í•˜ë‹¨ íƒ­ ê·¸ë¦¬ê¸° (ë¹ˆ ì‹œíŠ¸ë„ í‘œì‹œ)
    renderTabs() {
        this.tabsContainer.innerHTML = '';
        Object.keys(this.sheets).forEach(name => {
            const data = this.sheets[name];
            const isEmpty = !data || data.length === 0;

            let tab = document.createElement('div');
            tab.className = `sheet-tab ${name === this.currentSheetName ? 'active' : ''} ${isEmpty ? 'empty' : ''}`;
            tab.textContent = isEmpty ? `${name} (ë¹„ì–´ìˆìŒ)` : name;
            tab.onclick = () => this.switchSheet(name);
            this.tabsContainer.appendChild(tab);
        });
    }
}

/**
 * 2. ExcelIO: ë©€í‹° ì‹œíŠ¸ íŒŒì¼ ì…ì¶œë ¥ (ë¹ˆ ì‹œíŠ¸ ì²˜ë¦¬ ê°œì„ )
 */
class ExcelIO {
    constructor(gridManager) {
        this.grid = gridManager;
        this.fileInput = document.getElementById('fileInput');
        this.loadingOverlay = document.getElementById('file-loading-overlay');
        this.loadingMessage = document.getElementById('loading-message');
        this.fileInput.addEventListener('change', (e) => this.handleFile(e));
    }

    triggerImport() { this.fileInput.click(); }

    showLoading(message = 'íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...') {
        this.loadingMessage.textContent = message;
        this.loadingOverlay.classList.add('show');
    }

    hideLoading() {
        this.loadingOverlay.classList.remove('show');
    }

    async handleFile(e) {
        const file = e.target.files[0];
        if(!file) return;

        this.showLoading(`${file.name} íŒŒì¼ ë¡œë“œ ì¤‘...`);

        // ê°™ì€ íŒŒì¼ì„ ë‹¤ì‹œ ì„ íƒí•  ìˆ˜ ìˆë„ë¡ ì´ˆê¸°í™”
        e.target.value = '';

        // UI ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ ì•½ê°„ì˜ ì§€ì—°
        await new Promise(resolve => setTimeout(resolve, 50));

        const reader = new FileReader();
        reader.onload = async (event) => {
            try {
                this.showLoading('ë°ì´í„° íŒŒì‹± ì¤‘...');

                // UI ë¸”ë¡ ë°©ì§€ë¥¼ ìœ„í•´ setTimeout ì‚¬ìš©
                await new Promise(resolve => setTimeout(resolve, 10));

                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array' });

                this.showLoading(`${workbook.SheetNames.length}ê°œ ì‹œíŠ¸ ì²˜ë¦¬ ì¤‘...`);

                // ë¹„ë™ê¸°ë¡œ ì‹œíŠ¸ íŒŒì‹±
                const allSheetsData = {};
                for (let i = 0; i < workbook.SheetNames.length; i++) {
                    const sheetName = workbook.SheetNames[i];
                    const sheet = workbook.Sheets[sheetName];

                    // UI ë¸”ë¡ ë°©ì§€
                    if (i % 3 === 0) {
                        this.showLoading(`ì‹œíŠ¸ ì²˜ë¦¬ ì¤‘... (${i + 1}/${workbook.SheetNames.length})`);
                        await new Promise(resolve => setTimeout(resolve, 0));
                    }

                    const jsonData = XLSX.utils.sheet_to_json(sheet, { defval: "" });
                    allSheetsData[sheetName] = jsonData;
                }

                this.showLoading('í™”ë©´ ë Œë”ë§ ì¤‘...');
                await new Promise(resolve => setTimeout(resolve, 10));

                this.grid.loadSheets(allSheetsData);

                // ë Œë”ë§ì´ ì‹œì‘ëœ í›„ ë¡œë”© ìˆ¨ê¹€
                setTimeout(() => this.hideLoading(), 100);

            } catch (error) {
                console.error('íŒŒì¼ ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                this.hideLoading();
            }
        };

        reader.onerror = () => {
            alert('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            this.hideLoading();
        };

        reader.readAsArrayBuffer(file);
    }

    exportFile() {
        const wb = XLSX.utils.book_new();
        const sheets = this.grid.sheets;

        Object.keys(sheets).forEach(name => {
            const data = sheets[name];
            const ws = data && data.length > 0
                ? XLSX.utils.json_to_sheet(data)
                : XLSX.utils.aoa_to_sheet([]); // ë¹ˆ ì‹œíŠ¸ ì²˜ë¦¬
            XLSX.utils.book_append_sheet(wb, ws, name);
        });

        XLSX.writeFile(wb, "K-IFRS_Data_Validation_Result.xlsx");
    }
}

/**
 * 3. AIEngine: ì‹¤ì œ ChatGPT API ì—°ë™ (ë°ì´í„° ìƒ˜í”Œë§ & íˆìŠ¤í† ë¦¬ ì¶”ê°€)
 */
class AIEngine {
    constructor(gridManager) {
        this.grid = gridManager;
        this.input = document.getElementById('ai-prompt');
        this.apiKeyInput = document.getElementById('api-key');
        this.loading = document.getElementById('loading');
        this.historyContainer = document.getElementById('ai-history');
        this.history = [];
    }

    async processCommand() {
        const apiKey = this.apiKeyInput.value.trim();
        const prompt = this.input.value.trim();
        const currentData = this.grid.getCurrentData();

        if (!apiKey) {
            alert("OpenAI API Keyë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }
        if (!prompt) {
            alert("ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }
        if (currentData.length === 0) {
            alert("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        this.setLoading(true);
        const startTime = Date.now();

        try {
            // ë°ì´í„° ìƒ˜í”Œë§: 1000í–‰ ì´ìƒì´ë©´ ì²˜ìŒ 500í–‰ + ë§ˆì§€ë§‰ 500í–‰ë§Œ ì „ì†¡
            let sampledData = currentData;
            let isSampled = false;
            const MAX_ROWS = 1000;

            if (currentData.length > MAX_ROWS) {
                const halfSize = Math.floor(MAX_ROWS / 2);
                sampledData = [
                    ...currentData.slice(0, halfSize),
                    ...currentData.slice(-halfSize)
                ];
                isSampled = true;
            }

            // AIì—ê²Œ ë³´ë‚¼ ë©”ì‹œì§€ êµ¬ì„±
            const messages = [
                {
                    role: "system",
                    content: "You are a helpful data assistant. Output ONLY valid JSON array representing the modified data based on the user's command. Do not explain. Maintain the same keys/structure unless asked to change."
                },
                {
                    role: "user",
                    content: `Here is the current dataset in JSON${isSampled ? ' (sampled from ' + currentData.length + ' rows)' : ''}:\n${JSON.stringify(sampledData)}\n\nCommand: ${prompt}\n\nProcessed Data (JSON):`
                }
            ];

            const response = await fetch("https://api.openai.com/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: "gpt-3.5-turbo",
                    messages: messages,
                    temperature: 0.1
                })
            });

            const result = await response.json();

            if (result.error) {
                throw new Error(result.error.message);
            }

            const content = result.choices[0].message.content;

            // JSON íŒŒì‹± ì‹œë„
            try {
                const newData = JSON.parse(content);
                if (Array.isArray(newData)) {
                    this.grid.updateCurrentSheetData(newData);

                    const elapsedTime = ((Date.now() - startTime) / 1000).toFixed(1);
                    const resultSummary = `${currentData.length}í–‰ â†’ ${newData.length}í–‰ (${elapsedTime}ì´ˆ)`;

                    this.addHistory(prompt, resultSummary, false);
                    this.input.value = ''; // ëª…ë ¹ì–´ ì…ë ¥ì°½ ì´ˆê¸°í™”
                } else {
                    throw new Error("AIê°€ ìœ íš¨í•œ ë°ì´í„° í˜•ì‹ì„ ë°˜í™˜í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                }
            } catch (e) {
                console.error("Parsing Error:", content);
                this.addHistory(prompt, "íŒŒì‹± ì‹¤íŒ¨: " + e.message, true);
                alert("AI ì‘ë‹µì„ ì²˜ë¦¬í•˜ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. AI íŒ¨ë„ì—ì„œ ìì„¸í•œ ë‚´ìš©ì„ í™•ì¸í•˜ì„¸ìš”.");
            }

        } catch (error) {
            console.error(error);
            this.addHistory(prompt, "ì˜¤ë¥˜: " + error.message, true);
            alert("ì˜¤ë¥˜ ë°œìƒ: " + error.message);
        } finally {
            this.setLoading(false);
        }
    }

    // AI íˆìŠ¤í† ë¦¬ ì¶”ê°€
    addHistory(command, result, isError = false) {
        const entry = {
            time: new Date().toLocaleString('ko-KR'),
            command,
            result,
            isError
        };

        this.history.unshift(entry); // ìµœì‹  í•­ëª©ì„ ìœ„ì— í‘œì‹œ

        // íˆìŠ¤í† ë¦¬ëŠ” ìµœëŒ€ 20ê°œê¹Œì§€ë§Œ ìœ ì§€
        if (this.history.length > 20) {
            this.history.pop();
        }

        this.renderHistory();
    }

    // AI íˆìŠ¤í† ë¦¬ ë Œë”ë§
    renderHistory() {
        if (!this.historyContainer) return;

        this.historyContainer.innerHTML = '';

        if (this.history.length === 0) {
            this.historyContainer.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">ì•„ì§ AI ì‘ì—… ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        this.history.forEach(entry => {
            const div = document.createElement('div');
            div.className = `ai-entry ${entry.isError ? 'ai-entry-error' : ''}`;

            div.innerHTML = `
                <div class="ai-entry-time">${entry.time}</div>
                <div class="ai-entry-command">${entry.command}</div>
                <div class="ai-entry-result">${entry.result}</div>
            `;

            this.historyContainer.appendChild(div);
        });
    }

    setLoading(isLoading) {
        this.loading.style.display = isLoading ? 'inline' : 'none';
        document.getElementById('ai-btn').disabled = isLoading;
    }
}

// ì•± ì´ˆê¸°í™” ë° ì‹¤í–‰
const app = (() => {
    const gridManager = new GridManager('#spreadsheet', '#sheet-tabs');
    const excelIO = new ExcelIO(gridManager);
    const aiEngine = new AIEngine(gridManager);
    const commandManager = new CommandManager();
    const contextMenuManager = new ContextMenuManager(gridManager);
    const cellFormatter = new CellFormatter(gridManager);
    const rowColumnManager = new RowColumnManager(gridManager);
    const sortManager = new SortManager(gridManager);
    const filterManager = new FilterManager(gridManager);
    const searchManager = new SearchManager(gridManager);
    const validationManager = new ValidationManager(gridManager);
    const formulaEngine = new FormulaEngine(gridManager);

    const aiPanel = document.getElementById('ai-panel');
    const resizer = document.getElementById('ai-panel-resizer');

    // AI íŒ¨ë„ í† ê¸€ í•¨ìˆ˜
    const toggleAIPanel = () => {
        aiPanel.classList.toggle('collapsed');
    };

    // AI íŒ¨ë„ ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥
    let isResizing = false;
    let startX = 0;
    let startWidth = 0;

    resizer.addEventListener('mousedown', (e) => {
        isResizing = true;
        startX = e.clientX;
        startWidth = aiPanel.offsetWidth;
        document.body.classList.add('resizing');
        e.preventDefault();
    });

    document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;

        const diff = startX - e.clientX;
        const newWidth = startWidth + diff;

        if (newWidth >= 200 && newWidth <= 600) {
            aiPanel.style.width = newWidth + 'px';
        }
    });

    document.addEventListener('mouseup', () => {
        if (isResizing) {
            isResizing = false;
            document.body.classList.remove('resizing');
        }
    });

    // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
    document.addEventListener('keydown', (e) => {
        // Ctrl+Z: ì‹¤í–‰ ì·¨ì†Œ
        if (e.ctrlKey && e.key === 'z') {
            e.preventDefault();
            commandManager.undo();
        }
        // Ctrl+Y: ë‹¤ì‹œ ì‹¤í–‰
        if (e.ctrlKey && e.key === 'y') {
            e.preventDefault();
            commandManager.redo();
        }
        // Ctrl+C: ë³µì‚¬
        if (e.ctrlKey && e.key === 'c') {
            const selectedCells = document.querySelectorAll('td.selected');
            if (selectedCells.length > 0) {
                e.preventDefault();
                gridManager.copyCells();
            }
        }
        // Ctrl+V: ë¶™ì—¬ë„£ê¸°
        if (e.ctrlKey && e.key === 'v') {
            const selectedCells = document.querySelectorAll('td.selected');
            if (selectedCells.length > 0) {
                e.preventDefault();
                gridManager.pasteCells();
            }
        }
        // Ctrl+F: ê²€ìƒ‰
        if (e.ctrlKey && e.key === 'f') {
            e.preventDefault();
            searchManager.showSearchDialog();
        }
    });

    // ì´ˆê¸° ë°ì´í„° ì—†ìŒ - ì‚¬ìš©ìê°€ ì—‘ì…€ íŒŒì¼ì„ ì—´ì–´ì•¼ í•¨
    gridManager.loadSheets({});

    // ì´ˆê¸° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    commandManager.updateButtons();

    return {
        gridManager,
        excelIO,
        aiEngine,
        commandManager,
        contextMenuManager,
        cellFormatter,
        rowColumnManager,
        sortManager,
        filterManager,
        searchManager,
        validationManager,
        formulaEngine,
        toggleAIPanel
    };
})();

</script>

</body>
</html>